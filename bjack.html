<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <script src="graphics.js"></script>
    <script>
        var g = new Graphics(800, 600);
        var deck = new Array(51);
        var deckindex = 0;

        var userhand = [];
        var dealerhand = [];

        var screenDisplaying = false;

        var values = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
        var suits = ["hearts", "diamonds", "clubs", "spades"];

        var overlays = [new OverlayScreen("Natural"), new OverlayScreen("Bust"), new OverlayScreen("Fold?"), new OverlayScreen("Dealer Bust"), new OverlayScreen("Dealer Natural")];

        var turn = true;

        var currentCard = 1;

        for (var i = 0; i < values.length; i++) {
            for (var j = 0; j < suits.length; j++) {
                deck[deckindex] = new Card(suits[j], values[i]);
                deckindex++;
            }
        }

        shuffleDeck();

        function render() {
            g.setColor("rgb(20, 20, 20)");
            g.fillRect(0, 0, 800, 600);

            g.setColor("green");
            g.fillPolygon([0, 600, 25, 300, 775, 300, 800, 600]);
            g.setColor("blue");
            g.fillPolygon([620, 500, 630, 380, 730, 380, 740, 500]);
            g.setColor("black");
            g.drawPolygon([0, 600, 25, 300, 775, 300, 800, 600]);
            g.drawPolygon([620, 500, 630, 380, 730, 380, 740, 500]);

            renderOpponentCards();
            renderCards();


            g.setColor("red");
            g.setFont("24px sans");
            g.drawString("Sum: " + getSumInHand(userhand), 0, 24);
            g.drawString("Dealer Sum: " + getSumInHand(dealerhand), 0, 48);

            for (var i = 0; i < overlays.length; i++) {
                if (overlays[i].screenDisplaying) {
                    overlays[i].renderOverlay();
                }
            }
        }

        function renderCards() {

            for (var i = 0; i < getOccupiedSlotsInHand(userhand); i++) {
                userhand[i].render(((i + 1) * 170) - 50, 350, false);
            }

        }

        function renderOpponentCards() {

            for (var i = 0; i < getOccupiedSlotsInHand(dealerhand); i++) {
                dealerhand[i].renderFar(800 - (((i + 1) * 170)) - 130, 250);
            }

        }

        function shuffleDeck() {
            for (var i = 0; i < 1000; i++) {
                var location1 = Math.floor((Math.random() * deck.length));
                var location2 = Math.floor((Math.random() * deck.length));
                var tmp = deck[location1];

                deck[location1] = deck[location2];
                deck[location2] = tmp;
            }
        }

        /*
        function dealCard(hand, user) {
            var cardTimer = setTimeout(function () {
                hand[getOccupiedSlotsInHand(hand)] = deck[currentCard];
                console.log("Dealt " + deck[currentCard].value +  " to " + (user ? " user." : " dealer."));
                currentCard++;
            }, user ? 0 : 1000);
        }
        */




        function Card(suit, value) {
            this.suit = suit;
            this.value = value;

            this.render = function (x, y, facing) {
                this.x = x;
                this.y = y;
                g.setColor("rgba(0, 0, 0, 0.3)");
                g.fillOval(x - 20, y + 190, 190, 20);
                if (facing) {
                    g.setColor("blue");
                    g.fillRect(x, y, 150, 200); // will eventually replace with a texture, hopefully
                } else {
                    g.setColor("white");
                    g.fillRect(x, y, 150, 200);
                    // color is assumed by the suit
                    switch (suit) {
                        case "hearts":
                        case "diamonds":
                            g.setColor("red");
                            break;
                        case "spades":
                        case "clubs":
                            g.setColor("black");
                            break;
                    }
                    g.fillRect(x + 10, y + 10, 20, 20);
                    g.drawString(value, x + 35, y + 20);
                }
                g.setColor("black");
                g.setLineWidth(2);
                g.drawRect(x, y, 150, 200);
            };

            this.renderFar = function (x, y) {
                this.x = x;
                this.y = y;
                g.setColor("rgba(0, 0, 0, 0.3)");
                g.fillOval(x - 20, y + 90, 120, 20);
                g.setColor("blue");
                g.fillRect(x, y, 75, 100);
                g.setColor("black");
                g.setLineWidth(2);
                g.drawRect(x, y, 75, 100);
            }

            this.getX = function () {
                return this.x;
            }

            this.getY = function () {
                return this.y;
            }
        }

        function OverlayScreen(text) {
            this.text = text;
            this.screenDisplaying = false;

            this.renderOverlay = function () {
                this.screenDisplaying = true;
                g.setColor("rgba(0, 0, 0, 0.5)");
                g.fillRect(0, 0, 800, 600);
                g.setColor("red");
                g.drawString(this.text, 100, 100);
            }
        }

        function bust(hand) {
            return getSumInHand(userhand) > 21;
        }

        function natural(hand) {
            return getSumInHand(userhand) == 21;
        }

        function getSumInHand(hand) {
            var sum = 0;
            for (var i = 0; i < getOccupiedSlotsInHand(hand); i++) {
                switch (hand[i].value) {
                    case "A":
                        sum += (sum + 11 > 21) ? 1 : 11;
                        break;
                    case "J":
                    case "Q":
                    case "K":
                    case "10":
                        sum += 10;
                        break;
                    default:
                        sum += parseInt(hand[i].value);
                        break;
                }
            }

            //console.log("hand sum for " + getOccupiedSlotsInHand(hand) + " cards: " + sum);
            return sum;
        }

        var blocking = false;

        g.canvas.onmousedown = function (e) {
            switch (g.ctx.getImageData(e.offsetX, e.offsetY, 1, 1).data[1]) {
                case 128:
                    overlays[2].screenDisplaying = true;
                    break;
                case 0:
                    if (!blocking) {
                        userhand[getOccupiedSlotsInHand(userhand)] = deck[currentCard];
                        currentCard++;
                        blocking = true;
                    } else {
                        console.log("action blocked");
                    }
                    setTimeout(function () {
                        dealerhand[getOccupiedSlotsInHand(dealerhand)] = deck[currentCard];
                        currentCard++;
                        blocking = false;
                    }, 1000);

                    if (bust(userhand)) {
                        overlays[1].screenDisplaying = true;
                        break;
                    } else if (natural(userhand)) {
                        overlays[0].screenDisplaying = true;
                        break;
                    }

                    if (bust(dealerhand)) {
                        overlays[3].screenDisplaying = true;
                        break;
                    } else if (natural(dealerhand)) {
                        overlays[4].screenDisplaying = true;
                        break;
                    }
                    //dealCard(userhand, true);
                    //dealCard(dealerhand, false);
                    break;
            }
        }

        document.onkeydown = function (e) {
            // y = 89
            // n = 78
            console.log(e.which);
        }

        function getOccupiedSlotsInHand(hand) {
            var sum = 0;
            for (var i = 0; i < hand.length; i++) {
                //console.log("Value for " + i + " in hand: " + hand[i].value + " " + hand[i].suit);
                if (hand[i] != null) {
                    sum++;
                }
            }

            // console.log("hand size: " + sum);
            return sum;
        }

        function tick() {
            render();
            window.requestAnimationFrame(tick);
        }

        window.requestAnimationFrame(tick);
    </script>
</body>
</html>